res2 <- SDA_query(q2)
FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ",
in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
head(res2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, hzdept_r, hzdepb_r, hzname, awc_r, FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r, FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, hzdept_r, hzdepb_r, hzname, awc_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
head(res2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, co.key, hzdept_r, hzdepb_r, hzname, awc_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, c.cokey, hzdept_r, hzdepb_r, hzname, awc_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
head(res2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
head(res2)
.libPaths("C:/Felipe/Sotware&Coding/R_Library/library")  ;
co.sum.whc <- function(i) {
wt <- i$comppct_r[1] # keep the first component pct (they are all the same)
thick <- with(i, hzdepb_r - hzdept_r) # compute horizon thickness
whc <- thick * i$awc_r # compute water storage by horizon
whc.total <- sum(whc, na.rm=TRUE) # sum to get profile water storage
data.frame(whc=whc.total, wt=wt) # return profile water storage and component pct
}
mu.mean.whc <- function(i) {
whc <- wtd.mean(i$whc, weights=i$wt) # safely compute wt. mean water storage
data.frame(whc=whc) # return wt. mean water storage
}
library(Hmisc)
library(soilDB)
library(plyr)
library(raster)
library(aqp)
data(gSSURGO.chunk, package='soilDB')
gSSURGO.chunk <- ratify(gSSURGO.chunk, count=TRUE)
rat <- levels(gSSURGO.chunk)[[1]]
in.statement <- format_SQL_in_statement(rat$ID)
q <- paste("SELECT component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r
FROM component JOIN chorizon ON component.cokey = chorizon.cokey
AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC", sep="")
res <- SDA_query(q)
head(res)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
head(res2)
co.whc <- ddply(res, c('mukey', 'cokey'), co.sum.whc)
mu.whc <- ddply(co.whc, 'mukey', mu.mean.whc)
head(mu.whc)
names(mu.whc)[1] <- 'ID'
rat.new <- join(rat, mu.whc, type='left')
levels(gSSURGO.chunk) <- rat.new
r.new <- deratify(gSSURGO.chunk, att='whc')
plot(r.new)
library(plyr)
library(raster)
library(foreign)
r <- raster('C:\\Felipe\\PIHM-CYCLES\\PIHM\\PIHM_Felipe\\CNS\\Manhantango\\gssurgo_g_pa\\GSSURGO_PA_TIFF\\MahatangoGSSG1.tif') ;
r <- ratify(r)
rat <- levels(r)[[1]]
rat
in.statement2 <- format_SQL_in_statement(rat$ID)
in.statement2
q3 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement2," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
q3
res3 <- SDA_query(q3)
head(res2)
mu <- read.dbf('C:\\Felipe\\PIHM-CYCLES\\PIHM\\PIHM_Felipe\\CNS\\Manhantango\\gssurgo_g_pa\\GSSURGO_PA_TIFF\\MahatangoGSSG1.tif.vat.dbf') ;
names(mu)[1] <- 'ID'
library(Hmisc)
library(soilDB)
library(plyr)
library(raster)
library(aqp)
install.packages("soilDB", repos="http://R-Forge.R-project.org") # most recent copy from r-forge
install.packages("soilDB", repos = "http://R-Forge.R-project.org")
install.packages("foreign")
install.packages("foreign")
##### Working with the Package AQP #######
##### http://ncss-tech.github.io/AQP/soilDB/gSSURGO-SDA.html#####
#### Felipe Montes 2016 09 09 #############
#  Tell the program where the package libraries are  #####################
.libPaths("C:/Felipe/Sotware&Coding/R_Library/library")  ;
#### Install pakages #####
# function for computing profile-total water storage
co.sum.whc <- function(i) {
wt <- i$comppct_r[1] # keep the first component pct (they are all the same)
thick <- with(i, hzdepb_r - hzdept_r) # compute horizon thickness
whc <- thick * i$awc_r # compute water storage by horizon
whc.total <- sum(whc, na.rm=TRUE) # sum to get profile water storage
data.frame(whc=whc.total, wt=wt) # return profile water storage and component pct
}
# function for computing weighted-mean whc within a map unit
mu.mean.whc <- function(i) {
whc <- wtd.mean(i$whc, weights=i$wt) # safely compute wt. mean water storage
data.frame(whc=whc) # return wt. mean water storage
}
# load libraries
library(Hmisc)
library(soilDB)
library(plyr)
library(raster)
library(aqp)
data(gSSURGO.chunk, package='soilDB')
gSSURGO.chunk <- ratify(gSSURGO.chunk, count=TRUE)
rat <- levels(gSSURGO.chunk)[[1]]
in.statement <- format_SQL_in_statement(rat$ID)
q <- paste("SELECT component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r
FROM component JOIN chorizon ON component.cokey = chorizon.cokey
AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC", sep="")
res <- SDA_query(q)
head(res)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
head(res2)
co.whc <- ddply(res, c('mukey', 'cokey'), co.sum.whc)
mu.whc <- ddply(co.whc, 'mukey', mu.mean.whc)
head(mu.whc)
names(mu.whc)[1] <- 'ID'
rat.new <- join(rat, mu.whc, type='left')
levels(gSSURGO.chunk) <- rat.new
r.new <- deratify(gSSURGO.chunk, att='whc')
plot(r.new)
library(plyr)
library(raster)
library(foreign)
r <- raster('C:\\Felipe\\PIHM-CYCLES\\PIHM\\PIHM_Felipe\\CNS\\Manhantango\\gssurgo_g_pa\\GSSURGO_PA_TIFF\\MahatangoGSSG1.tif') ;
r <- ratify(r) ;
rat <- levels(r)[[1]] ;
in.statement2 <- format_SQL_in_statement(rat$ID)
q3 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement2," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res3 <- SDA_query(q3)
head(res2)
install.packages('raster', dep=TRUE)
install.packages('plyr', dep=TRUE)
install.packages('Hmisc', dep=TRUE)
install.packages('soilDB', dep=TRUE) # stable version from CRAN + dependencies
install.packages("soilDB", repos="http://R-Forge.R-project.org") # most recent copy from r-forge
install.packages("SSOAP", repos = "http://www.omegahat.org/R", type="source") # SSOAP and XMLSchema
install.packages("foreign")
install.packages("httr", dep=TRUE)
install.packages("rgdal", dep = TRUE)
install.packages("raster", dep = TRUE)
install.packages("rgeos", dep = TRUE)
install.packages("raster", dep = TRUE)
install.packages("plyr", dep = TRUE)
install.packages("soilDB", dep = TRUE)
install.packages("soilDB", repos = "http://R-Forge.R-project.org")
install.packages("Hmisc", dep = TRUE)
install.packages("httr", dep = TRUE)
install.packages("rgdal", dep = TRUE)
install.packages("raster", dep = TRUE)
install.packages("soilDB", dep = TRUE)
install.packages("Hmisc", dep = TRUE)
install.packages("rgdal", dep = TRUE)
install.packages("raster", dep = TRUE)
install.packages("soilDB", repos = "http://R-Forge.R-project.org")
install.packages("httr", dep = TRUE)
install.packages("raster", dep = TRUE)
install.packages("soilDB", repos = "http://R-Forge.R-project.org")
install.packages("rgdal", dep = TRUE)
install.packages("httr", dep = TRUE)
install.packages("rgdal", dep = TRUE)
install.packages("httr", dep = TRUE)
##### Working with the Package AQP #######
##### http://ncss-tech.github.io/AQP/soilDB/gSSURGO-SDA.html#####
#### Felipe Montes 2016 09 09 #############
#  Tell the program where the package libraries are  #####################
.libPaths("C:/Felipe/Sotware&Coding/R_Library/library")  ;
# function for computing profile-total water storage
co.sum.whc <- function(i) {
wt <- i$comppct_r[1] # keep the first component pct (they are all the same)
thick <- with(i, hzdepb_r - hzdept_r) # compute horizon thickness
whc <- thick * i$awc_r # compute water storage by horizon
whc.total <- sum(whc, na.rm=TRUE) # sum to get profile water storage
data.frame(whc=whc.total, wt=wt) # return profile water storage and component pct
}
# function for computing weighted-mean whc within a map unit
mu.mean.whc <- function(i) {
whc <- wtd.mean(i$whc, weights=i$wt) # safely compute wt. mean water storage
data.frame(whc=whc) # return wt. mean water storage
}
# load libraries
library(Hmisc)
library(soilDB)
library(plyr)
library(raster)
library(aqp)
library(sp)
library(rgdal)
library(raster)
library(rgeos)
library(lattice)
library(MASS)
# load chunk of gSSURGO
data(gSSURGO.chunk, package='soilDB')
# convert into a raster + RAT
gSSURGO.chunk <- ratify(gSSURGO.chunk, count=TRUE)
# save RAT to new object, will use later
rat <- levels(gSSURGO.chunk)[[1]]
# extract the map unit keys from the RAT, and format for use in an SQL IN-statement
in.statement <- format_SQL_in_statement(rat$ID)
# format query in SQL- raw data are returned
q <- paste("SELECT component.mukey, component.cokey, compname, comppct_r, hzdept_r, hzdepb_r, hzname, awc_r
FROM component JOIN chorizon ON component.cokey = chorizon.cokey
AND mukey IN ", in.statement, "ORDER BY mukey, comppct_r DESC, hzdept_r ASC", sep="")
# now get component and horizon-level data for these map unit keys
res <- SDA_query(q)
head(res)
q2 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res2 <- SDA_query(q2)
head(res2,20)
q3 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r, om_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement2," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
in.statement2 <- format_SQL_in_statement(rat$ID)
q3 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r, om_r FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement2," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res3 <- SDA_query(q3);
head(res2) ;
res3$id<-res3$mukey ;
res3$top<-res3$hzdept_r ;
res3$bottom<-res3$hzdepb_r ;
res3$name<-res3$hzname ;
depths(res3)<-id ~ top + bottom  ;
str(res3) ;
plot(res3, name='name')
plot(res3, name='name', color='om_r')
q3 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r, om_r,dbtenthbar_r, dbthirdbar_r, dbfifteenbar_r  FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement2," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res3 <- SDA_query(q3);
head(res2) ;
res3$id<-res3$mukey ;
res3$top<-res3$hzdept_r ;
res3$bottom<-res3$hzdepb_r ;
res3$name<-res3$hzname ;
depths(res3)<-id ~ top + bottom  ;
str(res3) ;
plot(res3, name='name', color='dbtenthbar_r')
plot(res3, name='name', color='claytotal_r')
head(res3) ;
plot(res3, name='name', color='dbthirdbar_r')
plot(res3[1:10], name='name', color='dbthirdbar_r')
res3[1]
res3[1:3]
print(res3[1])
print(res3[1:3])
head[res3]
plot(res3[1:3], name='name', color='dbthirdbar_r')
q3 <- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r, om_r,dbtenthbar_r, dbthirdbar_r, dbfifteenbar_r, fraggt10_r, frag3to10_r, sieveno10_r, sieveno40_r, sieveno200_r  FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement2," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
res3 <- SDA_query(q3);
head(res3) ;
res3$id<-res3$mukey ;
res3$top<-res3$hzdept_r ;
res3$bottom<-res3$hzdepb_r ;
res3$name<-res3$hzname ;
depths(res3)<-id ~ top + bottom  ;
str(res3) ;
plot(res3[1:10], name='name', color='dbthirdbar_r')
plot(res3[1:10], name='name', color='frag3to10_r')
install.packages("dplyr")
.libPaths("C:/Felipe/Sotware&Coding/R_Library/library")  ;
install.packages("dplyr")
# load libraries
library(Hmisc) ;
library(soilDB) ;
library(plyr) ;
library(raster) ;
library(aqp) ;
library(sp) ;
library(rgdal) ;
library(raster) ;
library(rgeos) ;
library(lattice) ;
library(MASS) ;
library(RColorBrewer) ;
library(ggplot2)  ;
#library(tmap) ;
library(dplyr)  ;
library(tidyr)  ;
library(devtools) ;
sessionInfo()
########################## import the raster file with the GSSURGO Data for the watershed in PIHM ####################
Manhatango_GSSURGO<- raster('C:\\Felipe\\PIHM-CYCLES\\PIHM\\PIHM_Felipe\\CNS\\Manhantango\\gssurgo_g_pa\\GSSURGO_PA_TIFF\\MahatangoGSSG1.tif') ;
# generate a RAT via raster package functionality
Manhatango_GSSURGO <- ratify(Manhatango_GSSURGO) ;
# extract RAT to a data.frame
MUKEYS <- levels(Manhatango_GSSURGO)[[1]] ;
################################ Query the Soil Data access database with SQL through R #################
# from https://sdmdataaccess.sc.egov.usda.gov/queryhelp.aspx
# and https://sdmdataaccess.sc.egov.usda.gov/documents/ReturningSoilTextureRelatedAttributes.pdf
# --Sample query begins.
# --Note that a pair of dashes denotes the beginning of a comment.
# SELECT
# saversion, saverest, -- attributes from table "sacatalog"
# l.areasymbol, l.areaname, l.lkey, -- attributes from table "legend"
# musym, muname, museq, mu.mukey, -- attributes from table "mapunit"
# comppct_r, compname, localphase, slope_r, c.cokey, -- attributes from table "component"
# hzdept_r, hzdepb_r, ch.chkey, -- attributes from table "chorizon"
# sandtotal_r, silttotal_r, claytotal_r, --total sand, silt and clay fractions from table "chorizon"
# sandvc_r, sandco_r, sandmed_r, sandfine_r, sandvf_r,--sand sub-fractions from table "chorizon"
# texdesc, texture, stratextsflag, chtgrp.rvindicator, -- attributes from table "chtexturegrp"
# texcl, lieutex, -- attributes from table "chtexture"
# texmod -- attributes from table "chtexturemod"
# FROM sacatalog sac
# INNER JOIN legend l ON l.areasymbol = sac.areasymbol AND l.areatypename = 'Non-MLRA Soil Survey Area'
# INNER JOIN mapunit mu ON mu.lkey = l.lkey
# AND mu.mukey IN
# ('107559','107646','107674','107682','107707','107794','107853','107854','107865','107867','107869','107870','107871')
# LEFT OUTER JOIN component c ON c.mukey = mu.mukey
# LEFT OUTER JOIN chorizon ch ON ch.cokey = c.cokey
# LEFT OUTER JOIN chtexturegrp chtgrp ON chtgrp.chkey = ch.chkey
# LEFT OUTER JOIN chtexture cht ON cht.chtgkey = chtgrp.chtgkey
# LEFT OUTER JOIN chtexturemod chtmod ON chtmod.chtkey = cht.chtkey
# --WHERE.
# --ORDER BY l.areaname, museq, comppct_r DESC, compname, hzdept_r -- standard soil report ordering
# --Sample query ends.
# extract the map unit keys from the RAT, and format for use in an SQL IN-statement
in.statement2 <- format_SQL_in_statement(MUKEYS$ID)
# format query in SQL- raw data are returned
Pedon.query<- paste0("SELECT component.mukey, component.cokey, compname, comppct_r, majcompflag, slope_r, hzdept_r, hzdepb_r,hzthk_r, hzname, awc_r, sandtotal_r, silttotal_r, claytotal_r, om_r,dbtenthbar_r, dbthirdbar_r, dbfifteenbar_r, fraggt10_r, frag3to10_r, sieveno10_r, sieveno40_r, sieveno200_r, ksat_r  FROM component JOIN chorizon ON component.cokey = chorizon.cokey AND mukey IN ", in.statement2," ORDER BY mukey, comppct_r DESC, hzdept_r ASC") ;
# now get component and horizon-level data for these map unit keys
Pedon.info<- SDA_query(Pedon.query);
head(Pedon.info) ;
# filter components that are the major components of each unit map with the Flag majcompflag=='Yes'
Pedon.info.MajorC<-Pedon.info[which(Pedon.info$majcompflag == 'Yes'),]  ;
head(Pedon.info.MajorC) ;
# check if there are mukeys with more than one dominant component
Pedon.info.MajorC$mukey.factor<-as.factor(Pedon.info.MajorC$mukey) ;
Pedon.info.MajorC$cokey.factor<-as.factor(Pedon.info.MajorC$cokey) ;
Pedon.info.MajorC$mukey_comppct_r<-paste(Pedon.info.MajorC$mukey.factor,Pedon.info.MajorC$comppct_r, sep = "_") ;
# Select major component mukeys that have also the highest component percent comppct_r
head(Pedon.info.MajorC)
Dominant<- aggregate(comppct_r ~ mukey.factor, data=Pedon.info.MajorC, FUN="max" , drop=T, simplify=T) ;
head(Dominant)
Dominant$mukey_comppct_r<-paste(Dominant$mukey.factor,Dominant$comppct_r, sep ="_");
Mukey.Pedon<-Pedon.info.MajorC[Pedon.info.MajorC$mukey_comppct_r %in% Dominant$mukey_comppct_r,]
data(sp4)
depths(sp4) <- id ~ top + bottom
slice(sp4, fm= 0:15 ~ sand + silt + clay + name + ex_Ca_to_Mg)
sessionInfo()
install.packages("aqp")
install.packages("aqp")
install.packages("aqp")
#############################################################################################################################
#
#  Program to read TOB3 binary files from the Campbell Scientific memory cards.
# The TOB3 is a proprietary fromat therefore is ts better to use the tools that Campbell Scientific has already developed
# The Loggernet software utility by Campbell, come with a C program to convert the TOB3 format to other formats.
# its documentation can be found on section B.4 "Converting Binary File Formats" of the Loggernet Manual.
# B.4.5 TOB32.EXE
#
# The TOB32.EXE command line utility is installed by default in the LoggerNet
# program directory at C:\Program Files\Campbellsci\Loggernet\tob32.exe. The
# output is similar to CardConvert. Command line switches are used to determine
# the new file format that will be created. Some of the basic switches available
# are listed below:
#   -h or -? | Help
# -a | ASCII (TOA5) Generates CSI Table Oriented ASCII version 5
# format files
# -b | Binary (TOB1) Generates CSI Table Oriented Binary version 1
# format files
# Some examples using these switches include:
#   tob32.exe -a mydata.dat (converts mydata.dat to TOA5 format)
# tob32.exe -b mydata.dat (converts mydata.dat to TOB1 format)
#
# The idea of calling the Cprogram TOB32.EXE from R came from  Darren Wilkinson's research blog "Calling C code from R" at:
# https://darrenjw.wordpress.com/2010/12/30/calling-c-code-from-r/
#
# Other Sources are:
# https://cran.r-project.org/doc/manuals/r-release/R-exts.html
# http://www.biostat.jhsph.edu/~rpeng/docs/interface.pdf
#
#
#
#  Felipe Montes,  2017/08/02
#
##############################################################################################################################
############################### Record Time To start##########################################################
TimeStart<-Sys.time()  ;
###############################################################################################################
#                          Loading Packages and setting up working directory
###############################################################################################################
#  Tell the program where the package libraries are  #####################
.libPaths("C:/Felipe/Sotware&Coding/R_Library/library")  ;
#  Set Working directory
setwd("C:\\Felipe\\Eddy Covariance System\\RCode\\TOB3intoR") ;
###############################################################################################################
#                         Call packages needed to process the data
#
###############################################################################################################
###############################################################################################################
#                        Example from "Calling C code from R"
###############################################################################################################
#   Cprogram
# #include <stdio.h>
# #include <math.h>
# #include <stdlib.h>
# #include <gsl/gsl_rng.h>
# #include <gsl/gsl_randist.h>
#
# int main(int argc, char *argv[])
# {
#   if (argc!=4) {
#     fprintf(stderr,"Usage: %s <Iters> <Thin> <Seed>\n",argv[0]);
#     exit(EXIT_FAILURE);
#   }
#   long N=(long) atoi(argv[1]);
#   long thin=(long) atoi(argv[2]);
#   long seed=(long) atoi(argv[3]);
#   long i,j;
#   gsl_rng *r = gsl_rng_alloc(gsl_rng_mt19937);
#   gsl_rng_set(r,seed);
#   double x=0;
#   double y=0;
#   printf("Iter x y\n");
#   for (i=0;i<N;i++) {
#     for (j=0;j<thin;j++) {
#       x=gsl_ran_gamma(r,3.0,1.0/(y*y+4));
#       y=1.0/(x+1)+gsl_ran_gaussian(r,1.0/sqrt(x+1));
#     }
#     printf("%ld %f %f\n",i,x,y);
#   }
#   exit(EXIT_SUCCESS);
# }
# R code to call the c program
#
# standalone<-function(N=10000,thin=500,
#                      seed=trunc(runif(1)*1e6),
#                      exec=file.path(".","standalone"),
#                      tmpfile=tempfile())
# {
#   command=paste(exec,N,thin,seed,">",tmpfile)
#   system(command)
#   read.table(tmpfile,header=TRUE)
# }
###############################################################################################################
#                        Using TOB32.exe from R
###############################################################################################################
# TOB32.exe
# C:\Program Files (x86)\Campbellsci\LoggerNet>.\tob32 -H
# .\tob32 -H
# v12.00
# Switches:
#   H|Help gives this message
# ?|?    gives this message
# d|DaDisp Sets output file format to DaDisp
# a|ASCII  (TOA5)  Output CSI Table Oriented ASCII version 5 format
# b|binary (TOB1) Output CSI Table Oriented Binary version 1 format
# e|EASE   Output EASE format(not implemented)
# f|check discontinuities, and fill missing floating data with NaN
# with scan_sec &scan_nano inputs
# i|ID2000  Output ID2000 format
# n|notime do not output timestamps on TOA5 output
# m ?| blank: create one output file per file marker,
# 0: don't care,        1: per file mark,
# 2: per removal mark,  3: per either mark
#
# o|create output on specified path
# r|output record number
# s|check discontinuities, and start new files for them
# with scan_sec &scan_nano inputs
# v|verbose output to CSIDebug.log
#
# examples:
# tob32 -d mydata.dat --converts to DaDisp format
# tob32 -a mydata.dat --converts to TOA5 format
# tob32 -b mydata.dat --converts to TOB1 format
# tob32 -f 0;0 -b mydata.dat --TOB1 format with discontinuities check
# tob32 -i mydata.dat --converts to ID2000 format
# tob32 -a -o d:\outpath\  mydata.dat --converts "mydata.dat",
# to TOA5 format, in directory \outputpath\
###############################################################################################################
#                        Program
###############################################################################################################
# Path C:\Felipe\Willow Project\Willow Experiments\Willow Rockview\EddyCovarianceData_Felipe\
# 2017\Willow\WillowOpenPathEddyCovarianceData\EC_W_OP_20170519
#######  get a list of the directories that have the files with the data
TOB3.Directories<-list.dirs("C:\\Felipe\\Willow_Project\\Willow_Experiments\\Willow_Rockview\\EddyCovarianceData_Felipe\\2017\\Corn\\CornClosedPathEddyCovarianceData", recursive=T) ;
#
TOB3.Directories
TOB3.file<-list.files(TOB3.Directories[7])[grep("lux", list.files(TOB3.Directories[2]), value=F)] ;
Dir.name<-paste0("./",strsplit(TOB3.Directories[2],split="/")[[1]][2]) ;
dir.create(Dir.name)
Dir.name
TOB3toTOA5inst<-paste0('tob32.exe -a -o ',Dir.name,"/ ", paste(TOB3.Directories[2],TOB3.file, sep="\\"))
system(TOB3toTOA5inst)
paste0('tob32.exe -a -o ',Dir.name,"/ ", paste(TOB3.Directories[2],TOB3.file, sep="\\"))
.libPaths("C:/Felipe/Sotware&Coding/R_Library/library")  ;
setwd("C:\\Felipe\\Eddy Covariance System\\RCode\\TOB3intoR") ;
TOB3.Directories<-list.dirs("C:\\Felipe\\Willow_Project\\Willow_Experiments\\Willow_Rockview\\EddyCovarianceData_Felipe\\2017\\Corn\\CornClosedPathEddyCovarianceData", recursive=T) ;
TOB3.file<-list.files(TOB3.Directories[7])[grep("lux", list.files(TOB3.Directories[2]), value=F)] ;
Dir.name<-paste0("./",strsplit(TOB3.Directories[2],split="/")[[1]][2]) ;
Dir.name<-paste0("./",strsplit(TOB3.Directories[7],split="/")[[1]][2]) ;
dir.create(Dir.name)
TOB3toTOA5inst<-paste0('tob32.exe -a -o ',Dir.name,"/ ", paste(TOB3.Directories[2],TOB3.file, sep="\\"))
TOB3toTOA5inst<-paste0('tob32.exe -a -o ',Dir.name,"/ ", paste(TOB3.Directories[7],TOB3.file, sep="\\"))
system(TOB3toTOA5inst)
read.table(paste0('tob32.exe -a -o ',Dir.name,"/ ", paste(TOB3.Directories[7],TOB3.file, sep="\\")))
paste0('tob32.exe -a -o ',Dir.name,"/ ", paste(TOB3.Directories[7],TOB3.file, sep="\\"))
paste0(Dir.name,"/ ", paste(TOB3.Directories[7],TOB3.file, sep="\\"))
read.table(paste(TOB3.Directories[7],TOB3.file, sep="\\"))
